<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attack Agent Training - Claude Assistant</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="desktop">
        <!-- Menu Bar -->
        <div class="menu-bar">
            <div class="menu-item">üçé Claude Assistant</div>
            <div class="menu-item">File</div>
            <div class="menu-item">Edit</div>
            <div class="menu-item">View</div>
            <div class="menu-item">Training</div>
            <div class="menu-item">Special</div>
        </div>
        
        <!-- Main Window -->
        <div class="window">
            <div class="window-header">
                <div class="window-buttons">
                    <div class="window-button close"></div>
                    <div class="window-button minimize"></div>
                    <div class="window-button zoom"></div>
                </div>
                <div class="window-title">üéØ Attack Agent Training</div>
            </div>
            
            <!-- Chat Header -->
            <div class="chat-toolbar">
                <div class="chat-title">üí¨ Chat</div>
                <div class="status-info">
                    <div class="model-status" id="model-status">Model: Claude Opus 4.1</div>
                </div>
            </div>
            
            <!-- Messages Area -->
            <div class="messages-panel" id="chat-messages">
                <!-- Empty - user starts conversation -->
            </div>
            
            <!-- Input Area -->
            <div class="input-toolbar">
                <textarea id="message-input" placeholder="Start a conversation..." rows="3"></textarea>
                <button id="send-button" class="mac-button">Send</button>
                
                <!-- Message Controls -->
                <div class="message-controls">
                    <button class="mac-button" id="undo-last" disabled>Undo Last</button>
                </div>
                
                <!-- Save Agent -->
                <div class="save-controls">
                    <input type="text" id="agent-name" placeholder="Agent name..." class="mac-input" />
                    <button class="mac-button success" id="save-agent">Save Agent</button>
                    <button class="mac-button danger" id="reset-training">Reset</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let conversationHistory = [];
        const selectedModel = 'claude-opus-4-1-20250805'; // Claude Opus 4.1
        
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const undoLastButton = document.getElementById('undo-last');
        
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'user-message' : 'agent-message';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function updateUndoButton() {
            // Enable undo only if we have at least one complete exchange (user + AI)
            const hasCompleteExchange = conversationHistory.length >= 2 && 
                                        conversationHistory[conversationHistory.length - 1].role === 'assistant';
            undoLastButton.disabled = !hasCompleteExchange;
        }
        
        function undoLastExchange() {
            // Remove last AI response and user message
            // This now properly truncates both frontend display AND conversation history
            // that gets sent to the API, ensuring server sees the truncated context
            if (conversationHistory.length >= 2) {
                // Remove from history array (this affects what gets sent to server)
                conversationHistory.pop(); // Remove AI response
                conversationHistory.pop(); // Remove user message
                
                // Remove from UI - last 2 messages
                if (chatMessages.lastElementChild) {
                    chatMessages.lastElementChild.remove(); // Remove AI message
                }
                if (chatMessages.lastElementChild) {
                    chatMessages.lastElementChild.remove(); // Remove user message
                }
                
                updateUndoButton();
            }
        }
        
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Prevent double submission
            if (sendButton.disabled) return;
            
            // Add user message
            addMessage(message, true);
            conversationHistory.push({role: 'user', content: message, timestamp: Date.now()});
            
            console.log('DEBUG: Conversation history length:', conversationHistory.length);
            console.log('DEBUG: Last message:', conversationHistory[conversationHistory.length - 1]);
            
            messageInput.value = '';
            sendButton.disabled = true;
            
            // Send to API with conversation history
            fetch('/simple-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    model: selectedModel,
                    conversation_history: conversationHistory
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessage(data.response, false);
                    conversationHistory.push({role: 'assistant', content: data.response, timestamp: Date.now()});
                } else {
                    addMessage('Error: ' + data.error, false);
                }
                sendButton.disabled = false;
                updateUndoButton();
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('Error: Failed to get response', false);
                sendButton.disabled = false;
                updateUndoButton();
            });
        }
        
        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        undoLastButton.addEventListener('click', undoLastExchange);
        
        document.getElementById('save-agent').addEventListener('click', () => {
            const agentName = document.getElementById('agent-name').value.trim();
            
            if (!agentName) {
                alert('Please enter an agent name');
                return;
            }
            
            if (conversationHistory.length === 0) {
                alert('No conversation to save');
                return;
            }
            
            // Convert conversation to Claude format
            let conversationText = '';
            conversationHistory.forEach(msg => {
                const role = msg.role === 'user' ? 'Human' : 'Assistant';
                conversationText += `${role}: ${msg.content}\n\n`;
            });
            
            const payload = {
                name: agentName,
                conversation_content: conversationText,
                provider: 'anthropic',
                model: selectedModel  // Use the hardcoded selectedModel variable
            };
            
            console.log('Sending save request with payload:', payload);
            
            fetch('/create_personality', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    alert(`Agent saved successfully!\nID: ${data.personality_id}\nCheck personalities/ folder for new files.`);
                    document.getElementById('agent-name').value = '';
                } else {
                    alert('Error saving agent: ' + data.error);
                    console.error('Save failed:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving agent: ' + error.message);
            });
        });
        
        document.getElementById('reset-training').addEventListener('click', () => {
            if (confirm('Reset conversation? This cannot be undone.')) {
                // Reset UI immediately
                conversationHistory = [];
                chatMessages.innerHTML = '';
                document.getElementById('agent-name').value = '';
                updateUndoButton();
            }
        });
    </script>
</body>
</html>